name: Paper Section Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'paper/**/*.tex'
      - 'paper/**/*.bib'
      - 'paper/figures/**'

jobs:
  claude-paper-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Paper Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request for a Journal of Plasma Physics paper on GANDALF, a KRMHD turbulence solver.

            **Context:** Check CLAUDE.md for project guidelines including:
            - JPP writing style (active voice, expert audience, quantitative focus)
            - Scientific writing guidelines for plasma physics papers
            - Sub-agent roles (physics-narrator, latex-equations, etc.)

            **Review Focus based on changed files:**

            If this is the **Mathematical Formulation** section, check:
            - Correct KRMHD equations derivation from gyrokinetics
            - Clear statement of assumptions (k⊥ρᵢ ≪ 1, k∥ ≪ k⊥, strong guide field)
            - Proper Hermite moment expansion formulation
            - Non-dimensionalization and normalization
            - Dispersion relations and conservation properties
            - All variables defined consistent with notation.tex
            - All referenced equations numbered

            If this is the **Introduction** section, check:
            - Clear physics motivation for kinetic turbulence and KRMHD
            - Appropriate context on existing codes (Viriato, GS2, AstroGK)
            - Compelling case for JAX-based implementation on commodity hardware
            - Smooth flow from problem statement to solution

            If this is the **Numerical Methods** section, check:
            - Clear explanation of spectral methods advantages
            - Proper description of dealiasing (2/3 rule)
            - Time integration scheme details (RK4)
            - Boundary condition treatment
            - Parallel/perpendicular discretization choices

            If this is the **Verification** section, check:
            - Appropriate benchmark selection (Alfvén waves, Orszag-Tang, turbulent spectra)
            - Clear presentation of expected vs actual results
            - Convergence rate demonstration
            - Quantitative error metrics

            **General checks for all sections:**
            - Physics correctness and completeness
            - Mathematical rigor appropriate for JPP audience
            - Notation consistency with paper/notation.tex
            - All claims supported by citations
            - Active voice, present tense for methods
            - No undefined terms or notation

            Use `gh pr comment` to post your review findings. Be constructive and specific about any issues found.

          # Allow Claude to use gh commands for posting reviews
          claude_args: '--allowed-tools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"'
